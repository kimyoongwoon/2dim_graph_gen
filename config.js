// ============================================================================
// config.js - Ï∞®Ìä∏ ÏÑ§Ï†ï ÌéòÏù¥ÏßÄ Î°úÏßÅ
// ============================================================================

import { sessionStorageManager } from './shared/session_storage_manager/index.js';
import {
    dataValidator,
    dimensionCalculator,
    configBuilder
} from './data_pipeline_configuration_source/index.js';

import { showError } from './shared/error_handler.js';

// Ï†ÑÏó≠ Î≥ÄÏàòÎì§
let raw_data = null;
let fieldTypes = {};
let numericFields = [];
let currentDimension = null;
let currentIs3D = null;
let maxAvailableDimensions = 4;

// ============================================================================
// Îç∞Ïù¥ÌÑ∞ Î°úÎìú Î∞è Ï¥àÍ∏∞Ìôî
// ============================================================================

function loadDataFromSessionStorage() {
    updateStatus('Ï†ÄÏû•Îêú Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ï§ë...', 'info');

    try {
        // sessionStorageÏóêÏÑú Îç∞Ïù¥ÌÑ∞ Î°úÎìú
        const { data, meta } = sessionStorageManager.loadRawDataFromSessionStorage();
        raw_data = data;

        const fieldNames = meta.fieldNames.join(', ');
        updateStatus(`‚úÖ ${data.length}Í∞ú Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏôÑÎ£å | ÌïÑÎìú: ${fieldNames}`, 'success');

        // ÌïÑÎìú ÌÉÄÏûÖ Î∂ÑÏÑù (Í∏∞Ï°¥ generation Îã®Í≥ÑÏóêÏÑú Î∂ÑÏÑùÎêú Í≤ÉÏùÑ Ïû¨ÏÇ¨Ïö©Ìï† ÏàòÎèÑ ÏûàÏùå)
        fieldTypes = analyzeFieldTypes(data);

        // Ïà´Ïûê ÌïÑÎìú Î™©Î°ù Ï∂îÏ∂ú
        numericFields = dimensionCalculator.getNumericFields(data);
        console.log('[CONFIG] Ïà´Ïûê ÌïÑÎìú:', numericFields);

        // ÏµúÎåÄ Ï∞®ÏõêÏàò Í≥ÑÏÇ∞
        maxAvailableDimensions = dimensionCalculator.calculateAvailableDimensionsFromData(data);

        // 2D/3D Î™®Îìú ÏÑ†ÌÉù UI ÌëúÏãú
        showModeSelection();

        document.getElementById('chartConfigSection').style.display = 'block';

    } catch (error) {
        console.error('[CONFIG] Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïò§Î•ò:', error);
        updateStatus(`Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®: ${error.message}. Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ±Í∏∞Î°ú ÎèåÏïÑÍ∞ÄÏ£ºÏÑ∏Ïöî.`, 'error');
        document.getElementById('chartConfigSection').style.display = 'none';
    }
}

// Í∞ÑÎã®Ìïú ÌïÑÎìú ÌÉÄÏûÖ Î∂ÑÏÑù (generation Îã®Í≥ÑÏôÄ ÎèôÏùºÌïú Î°úÏßÅ)
function analyzeFieldTypes(data) {
    const types = {};
    if (data.length === 0) return types;
    
    const fields = Object.keys(data[0]);
    fields.forEach(field => {
        const sampleValue = data[0][field];
        types[field] = typeof sampleValue === 'number' ? 'double' : 'string';
    });
    
    return types;
}

// ============================================================================
// UI Í¥ÄÎ¶¨ Ìï®ÏàòÎì§
// ============================================================================

function updateStatus(message, type = 'info') {
    const dataInfo = document.getElementById('data-info');
    if (dataInfo) {
        dataInfo.innerHTML = `<strong>${message}</strong>`;
        dataInfo.className = `data-info ${type}`;
    }
}

function showModeSelection() {
    console.log('[CONFIG] 2D/3D Î™®Îìú ÏÑ†ÌÉù UI ÌëúÏãú');

    clearAllSelectionUI();

    const modeContainer = document.createElement('div');
    modeContainer.className = 'mode-selection-container';
    modeContainer.style.cssText = `
        display: flex;
        gap: 15px;
        align-items: center;
        margin: 15px 0;
        padding: 15px;
        background: #e3f2fd;
        border: 1px solid #2196f3;
        border-radius: 4px;
    `;

    const label = document.createElement('span');
    label.textContent = 'üìä Ï∞®Ìä∏ Î™®Îìú ÏÑ†ÌÉù:';
    label.style.cssText = 'font-weight: bold; color: #333; font-size: 16px;';
    modeContainer.appendChild(label);

    // 2D Î≤ÑÌäº
    const btn2D = document.createElement('button');
    btn2D.textContent = '2D Ï∞®Ìä∏ (Plotly)';
    btn2D.className = 'mode-btn btn-2d';
    btn2D.style.cssText = `
        padding: 10px 20px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        font-weight: bold;
        transition: background-color 0.2s;
    `;
    btn2D.onclick = () => selectMode(false);

    // 3D Î≤ÑÌäº
    const btn3D = document.createElement('button');
    btn3D.textContent = '3D Ï∞®Ìä∏ (Plotly)';
    btn3D.className = 'mode-btn btn-3d';
    btn3D.style.cssText = `
        padding: 10px 20px;
        background: #28a745;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        font-weight: bold;
        transition: background-color 0.2s;
    `;

    const canSupport3D = dimensionCalculator.canSupport3D(raw_data);
    if (canSupport3D && numericFields.length >= 3) {
        btn3D.onclick = () => selectMode(true);
    } else {
        btn3D.disabled = true;
        btn3D.style.background = '#6c757d';
        btn3D.style.cursor = 'not-allowed';
        btn3D.title = `3D Ï∞®Ìä∏Î•º ÏúÑÌï¥ÏÑúÎäî Ïà´Ïûê ÌïÑÎìúÍ∞Ä 3Í∞ú Ïù¥ÏÉÅ ÌïÑÏöîÌï©ÎãàÎã§ (ÌòÑÏû¨: ${numericFields.length}Í∞ú)`;
    }

    modeContainer.appendChild(btn2D);
    modeContainer.appendChild(btn3D);

    const axisMapping = document.getElementById('axisMapping');
    axisMapping.parentNode.insertBefore(modeContainer, axisMapping);
}

function selectMode(is3D) {
    console.log('[CONFIG] Î™®Îìú ÏÑ†ÌÉù:', is3D ? '3D' : '2D');
    currentIs3D = is3D;

    // Î≤ÑÌäº Ïä§ÌÉÄÏùº ÏóÖÎç∞Ïù¥Ìä∏
    document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.style.background = '#6c757d';
    });

    const activeBtn = document.querySelector(is3D ? '.btn-3d' : '.btn-2d');
    if (activeBtn && !activeBtn.disabled) {
        activeBtn.style.background = is3D ? '#28a745' : '#007bff';
    }

    if (is3D) {
        currentDimension = 3;
        hide2DSpecificUI();
        show3DModeInfo();
        updateFieldSelection();
    } else {
        hide3DSpecificUI();
        showDimensionSelection();
    }
}

function showDimensionSelection() {
    const existingDimSelector = document.querySelector('.dimension-selection-container');
    if (existingDimSelector) {
        existingDimSelector.remove();
    }

    const dimContainer = document.createElement('div');
    dimContainer.className = 'dimension-selection-container';
    dimContainer.style.cssText = `
        display: flex;
        gap: 15px;
        align-items: center;
        margin: 15px 0;
        padding: 15px;
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 4px;
    `;

    const label = document.createElement('span');
    label.textContent = 'üìê Ï∞®ÏõêÏàò ÏÑ†ÌÉù:';
    label.style.cssText = 'font-weight: bold; color: #333; font-size: 14px;';
    dimContainer.appendChild(label);

    const select = document.createElement('select');
    select.id = 'dimensionSelect';
    select.style.cssText = `
        padding: 8px 12px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 14px;
        min-width: 200px;
    `;

    select.innerHTML = '<option value="">Ï∞®Ïõê ÏÑ†ÌÉù</option>';
    for (let dim = 1; dim <= maxAvailableDimensions; dim++) {
        const label = dim === 1 ? '1Ï∞®Ïõê (ÏÑ†Ìòï/Ïπ¥ÌÖåÍ≥†Î¶¨)' :
            dim === 2 ? '2Ï∞®Ïõê (X-Y ÏÇ∞Ï†êÎèÑ)' :
                dim === 3 ? '3Ï∞®Ïõê (X-Y + ÌÅ¨Í∏∞/ÏÉâÏÉÅ)' :
                    '4Ï∞®Ïõê (X-Y + ÌÅ¨Í∏∞ + ÏÉâÏÉÅ)';
        select.innerHTML += `<option value="${dim}">${label}</option>`;
    }

    select.onchange = onDimensionChange;
    dimContainer.appendChild(select);

    const modeContainer = document.querySelector('.mode-selection-container');
    modeContainer.parentNode.insertBefore(dimContainer, modeContainer.nextSibling);
}

function onDimensionChange() {
    const dimension = parseInt(document.getElementById('dimensionSelect').value);
    currentDimension = dimension;

    if (!dimension) {
        hideFieldSelection();
        hideChartTypes();
        return;
    }

    show2DChartTypeUI();
    updateFieldSelection();
}

function updateFieldSelection() {
    if (currentDimension === null || currentIs3D === null) {
        hideFieldSelection();
        return;
    }

    const container = document.getElementById('axisMapping');
    container.innerHTML = '';

    const fieldCount = currentIs3D ? 3 : currentDimension;
    const fragment = document.createDocumentFragment();

    for (let i = 0; i < fieldCount; i++) {
        const div = document.createElement('div');
        div.className = 'axis-selector';

        const label = document.createElement('label');
        if (currentIs3D) {
            const axisNames = ['XÏ∂ï (Ïà´ÏûêÎßå)', 'YÏ∂ï (Ïà´ÏûêÎßå)', 'ZÏ∂ï (Ïà´ÏûêÎßå)'];
            label.innerHTML = `${axisNames[i]}:<br><small>3D Í≥µÍ∞Ñ Ï¢åÌëú</small>`;
        } else {
            label.innerHTML = `ÌïÑÎìú ${i + 1}:<br><small>${dataValidator.getFieldDescription(i, currentDimension)}</small>`;
        }

        const select = document.createElement('select');
        select.id = `field${i}`;
        select.className = 'field-selector';
        select.onchange = updateAllFieldOptions;
        select.innerHTML = '<option value="">ÌïÑÎìú ÏÑ†ÌÉù</option>';

        div.appendChild(label);
        div.appendChild(select);
        fragment.appendChild(div);
    }

    container.appendChild(fragment);
    updateAllFieldOptions();

    if (currentIs3D) {
        const chart3DTypes = get3DChartTypes(3);
        if (chart3DTypes.length > 0) {
            const defaultType = chart3DTypes[0];
            const chartTypeSelect = document.getElementById('chartTypeSelect');
            if (chartTypeSelect) {
                chartTypeSelect.innerHTML = `<option value="${defaultType.value}" selected>${defaultType.label}</option>`;
            }
        }
    }

    checkFormComplete();
}

function updateAllFieldOptions() {
    const fieldCount = currentIs3D ? 3 : currentDimension;
    if (fieldCount === null) return;

    const availableFields = currentIs3D ? numericFields : Object.keys(fieldTypes);
    const selectedFields = [];

    for (let i = 0; i < fieldCount; i++) {
        const fieldSelect = document.getElementById(`field${i}`);
        if (fieldSelect && fieldSelect.value) {
            selectedFields.push(fieldSelect.value);
        }
    }

    for (let i = 0; i < fieldCount; i++) {
        const fieldSelect = document.getElementById(`field${i}`);
        if (!fieldSelect) continue;

        const currentValue = fieldSelect.value;
        let fieldOptions = availableFields;

        if (!currentIs3D && i > 0) {
            fieldOptions = fieldOptions.filter(field => fieldTypes[field] === 'double');
        }

        fieldOptions = fieldOptions.filter(field =>
            !selectedFields.includes(field) || field === currentValue
        );

        const newOptions = ['<option value="">ÌïÑÎìú ÏÑ†ÌÉù</option>'];
        fieldOptions.forEach(field => {
            const typeLabel = fieldTypes[field] === 'string' ? '[Î¨∏Ïûê]' : '[Ïà´Ïûê]';
            const selected = field === currentValue ? ' selected' : '';
            newOptions.push(`<option value="${field}"${selected}>${typeLabel} ${field}</option>`);
        });

        fieldSelect.innerHTML = newOptions.join('');
    }

    checkFormComplete();
}

function checkFormComplete() {
    const dimension = currentDimension;
    const is3D = currentIs3D;
    let chartType;

    if (is3D) {
        const chart3DTypes = get3DChartTypes(3);
        chartType = chart3DTypes.length > 0 ? chart3DTypes[0].value : null;
    } else {
        chartType = document.getElementById('chartTypeSelect')?.value;
    }

    const fieldCount = is3D ? 3 : dimension;
    const selectedFields = [];
    if (fieldCount) {
        for (let i = 0; i < fieldCount; i++) {
            const fieldElement = document.getElementById(`field${i}`);
            if (fieldElement && fieldElement.value) {
                selectedFields.push(fieldElement.value);
            }
        }
    }

    let isComplete = false;
    try {
        isComplete = dataValidator.validateFormCompleteness({
            dimension: fieldCount,
            chartType,
            selectedFields
        });
    } catch (error) {
        console.warn('[CONFIG] Ìèº ÏôÑÏÑ±ÎèÑ Í≤ÄÏ¶ù Ïò§Î•ò:', error);
        isComplete = false;
    }

    const proceedBtn = document.getElementById('proceedBtn');
    if (proceedBtn) {
        proceedBtn.disabled = !isComplete;
    }
}

// ============================================================================
// Ï∞®Ìä∏ ÌÉÄÏûÖ Í¥ÄÎ†®
// ============================================================================

function get2DChartTypes(dimension) {
    const chart2DTypes = {
        1: [
            { value: 'line1d', label: 'Line Chart' },
            { value: 'category', label: 'Category Chart' }
        ],
        2: [
            { value: 'scatter', label: 'Scatter Plot' },
            { value: 'size', label: 'Size Chart' },
            { value: 'color', label: 'Color Chart' }
        ],
        3: [
            { value: 'scatter_size', label: 'Scatter + Size' },
            { value: 'scatter_color', label: 'Scatter + Color' },
            { value: 'size_color', label: 'Size + Color' }
        ],
        4: [
            { value: 'scatter_size_color', label: 'Scatter + Size + Color' }
        ]
    };
    return chart2DTypes[dimension] || [];
}

function get3DChartTypes(dimension) {
    return [{ value: '3d_surface_scatter', label: '3D Surface + Scatter' }];
}

function show2DChartTypeUI() {
    const chartTypeSection = document.querySelector('.config-column:nth-child(2)');
    if (!chartTypeSection) return;

    const chartTypeSelector = chartTypeSection.querySelector('#chartTypeSelect').closest('.axis-selector');
    if (chartTypeSelector) {
        chartTypeSelector.style.display = 'flex';
    }

    const advancedOptions = chartTypeSection.querySelector('.advanced-options');
    if (advancedOptions) {
        advancedOptions.style.display = 'block';
    }

    const infoDiv = chartTypeSection.querySelector('.mode-info');
    if (infoDiv) {
        infoDiv.remove();
    }

    if (currentDimension) {
        const chart2DTypes = get2DChartTypes(currentDimension);
        updateChartTypes(chart2DTypes);
    }
}

function show3DModeInfo() {
    const chartTypeSection = document.querySelector('.config-column:nth-child(2)');
    if (!chartTypeSection) return;

    const chartTypeSelector = chartTypeSection.querySelector('#chartTypeSelect').closest('.axis-selector');
    if (chartTypeSelector) {
        chartTypeSelector.style.display = 'none';
    }

    const advancedOptions = chartTypeSection.querySelector('.advanced-options');
    if (advancedOptions) {
        advancedOptions.style.display = 'none';
    }

    let infoDiv = chartTypeSection.querySelector('.mode-info');
    if (!infoDiv) {
        infoDiv = document.createElement('div');
        infoDiv.className = 'mode-info';
        infoDiv.style.cssText = `
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border: 1px solid #c3e6cb;
            border-radius: 4px;
            margin: 10px 0;
            font-size: 14px;
        `;
        chartTypeSelector.parentNode.insertBefore(infoDiv, chartTypeSelector);
    }
    infoDiv.innerHTML = `
        <strong>üåê 3D Î™®Îìú (Plotly)</strong><br>
        ‚Ä¢ Ï∞®Ïõê: 3Ï∞®Ïõê Í≥†Ï†ï (X, Y, ZÏ∂ï)<br>
        ‚Ä¢ Ï∞®Ìä∏ ÌÉÄÏûÖ: Surface + Scatter ÏûêÎèô ÏÑ§Ï†ï<br>
        ‚Ä¢ Î™®Îì† Ï∂ïÏùÄ Ïà´Ïûê ÌïÑÎìúÎßå ÏÇ¨Ïö© Í∞ÄÎä•
    `;
}

function updateChartTypes(types) {
    const select = document.getElementById('chartTypeSelect');
    if (!select) return;

    select.innerHTML = '<option value="">Ï∞®Ìä∏ ÌÉÄÏûÖ ÏÑ†ÌÉù</option>';
    types.forEach(type => {
        select.innerHTML += `<option value="${type.value}">${type.label}</option>`;
    });

    select.onchange = checkFormComplete;
}

// ============================================================================
// UI Ï†ïÎ¶¨ Ìï®ÏàòÎì§
// ============================================================================

function clearAllSelectionUI() {
    const containers = [
        '.mode-selection-container',
        '.dimension-selection-container'
    ];

    containers.forEach(selector => {
        const element = document.querySelector(selector);
        if (element) element.remove();
    });
}

function hide2DSpecificUI() {
    const dimContainer = document.querySelector('.dimension-selection-container');
    if (dimContainer) {
        dimContainer.style.display = 'none';
    }
}

function hide3DSpecificUI() {
    const infoDiv = document.querySelector('.mode-info');
    if (infoDiv) {
        infoDiv.remove();
    }
}

function hideFieldSelection() {
    const container = document.getElementById('axisMapping');
    if (container) {
        container.innerHTML = '';
    }
}

function hideChartTypes() {
    updateChartTypes([]);
}

// ============================================================================
// ÏÑ§Ï†ï ÎπåÎçî Ìï®ÏàòÎì§
// ============================================================================

function buildScalingConfig() {
    const scalingType = document.getElementById('sizeScaling')?.value || 'default';
    
    switch (scalingType) {
        case 'sigmoid':
            const k = parseFloat(document.getElementById('sigmoidK')?.value) || 1.0;
            return {
                type: 'sigmoid',
                params: { k }
            };
            
        case 'linear':
            // Í∏∞Î≥∏ ÏÑ†Ìòï ÌååÎùºÎØ∏ÌÑ∞ (ÌïÑÏöîÏãú UIÎ°ú ÌôïÏû• Í∞ÄÎä•)
            return {
                type: 'linear',
                params: { a: 1.0, b: 0 }
            };
            
        default:
            return {
                type: 'default'
            };
    }
}

// ============================================================================
// ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò Ìï®ÏàòÎì§
// ============================================================================

window.proceedToVisualization = function() {
    if (!raw_data || raw_data.length === 0) {
        showError('Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§');
        return;
    }

    const dimension = currentIs3D ? 3 : currentDimension;
    let chartType;

    if (currentIs3D) {
        const chart3DTypes = get3DChartTypes(3);
        chartType = chart3DTypes.length > 0 ? chart3DTypes[0].value : null;
    } else {
        chartType = document.getElementById('chartTypeSelect').value;
    }

    const fieldCount = currentIs3D ? 3 : dimension;
    const selectedFields = [];
    for (let i = 0; i < fieldCount; i++) {
        const fieldElement = document.getElementById(`field${i}`);
        if (fieldElement && fieldElement.value) {
            selectedFields.push(fieldElement.value);
        }
    }

    // ÏÑ§Ï†ïÏùÑ sessionStorageÏóê Ï†ÄÏû•
    const chartConfig = {
        dimension,
        chartType,
        selectedFields,
        is3D: currentIs3D,
        scalingConfig: buildScalingConfig(),
        colorConfig: { type: 'blueRed' } // Í∏∞Î≥∏ ÏÉâÏÉÅ ÏÑ§Ï†ï
    };

    try {
        sessionStorage.setItem('chartConfig', JSON.stringify(chartConfig));
        console.log('[CONFIG] Ï∞®Ìä∏ ÏÑ§Ï†ï Ï†ÄÏû• ÏôÑÎ£å:', chartConfig);
        
        // ÏãúÍ∞ÅÌôî ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô
        window.location.href = 'visualization.html';
    } catch (error) {
        console.error('[CONFIG] ÏÑ§Ï†ï Ï†ÄÏû• Ïò§Î•ò:', error);
        showError('ÏÑ§Ï†ï Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§: ' + error.message);
    }
};

window.goBackToGenerator = function() {
    window.location.href = 'index.html';
};

// ============================================================================
// ÌéòÏù¥ÏßÄ Ï¥àÍ∏∞Ìôî
// ============================================================================

document.addEventListener('DOMContentLoaded', () => {
    // ÌÅ¨Í∏∞ Ïä§ÏºÄÏùºÎßÅ Î≥ÄÍ≤Ω Ìï∏Îì§Îü¨
    const sizeScalingSelect = document.getElementById('sizeScaling');
    if (sizeScalingSelect) {
        sizeScalingSelect.addEventListener('change', function() {
            const sigmoidContainer = document.getElementById('sigmoidKContainer');
            if (sigmoidContainer) {
                sigmoidContainer.style.display = this.value === 'sigmoid' ? 'flex' : 'none';
            }
        });
    }

    loadDataFromSessionStorage();
});